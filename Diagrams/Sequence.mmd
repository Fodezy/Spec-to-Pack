sequenceDiagram
  autonumber
  participant U as User
  participant CLI as CLI (studiogen)
  participant ORCH as Orchestrator
  participant SPEC as SpecBuilder
  participant VALID as SchemaValidator
  participant FRA as Framer (lite)
  participant LIB as LibrarianAgent
  participant VS as Vector Store
  participant AG as Content Agents
  participant TMP as TemplateRenderer
  participant PKG as Packager
  participant FS as Output Dir
  participant AUD as Audit Log

  U->>CLI: run generate (--offline | --research)
  CLI->>ORCH: start(run_id, dials)
  ORCH->>SPEC: build_spec(idea, decisions)
  SPEC-->>ORCH: SourceSpec
  ORCH->>VALID: validate(SourceSpec)
  VALID-->>ORCH: ok | errors
  alt invalid spec
    ORCH->>AUD: log(validation_failed, errors)
    ORCH-->>CLI: exit(2)
  else valid
    ORCH->>FRA: fill_required_fields(SourceSpec)
    FRA-->>ORCH: SourceSpec'
    opt research mode
      ORCH->>LIB: fetch_and_chunk(references)
      LIB->>VS: upsert(embeddings)
      VS-->>LIB: ok
      LIB-->>ORCH: context_ready
    end
    ORCH->>AG: generate_artifacts(SourceSpec', context?)
    AG-->>ORCH: artifact_data
    ORCH->>TMP: render(templates, artifact_data)
    TMP-->>ORCH: files
    ORCH->>PKG: package(files â†’ zips, manifest)
    PKG-->>ORCH: zips + manifest
    ORCH->>FS: write(files, zips, manifest)
    ORCH->>AUD: log(run_completed)
    ORCH-->>CLI: exit(0)
  end
